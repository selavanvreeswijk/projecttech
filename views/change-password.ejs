<!DOCTYPE html>
<html lang="en ">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Change password</title>
        <link rel="stylesheet" href="/style.css">

        <%- include('partials/header') %>    

        <style>
        /* Error: OOK IN ALGEMENE STYLING ZETTEN */ 
        .error {
                color: red;
                font-size: 14px;
                display: none;
                margin-top: 5px;
            }

            .error-input {
                border: 2px solid red !important;
            }
        </style>
    </head>

    <body class="forms-body">
        <section class="forms-container">
            <h1 class="forms-h1">Change password</h1>

            <div class="forms">
                <form id="change-password-form" action="/change-password" method="POST">
                    <div>
                        <label for="oldPassword">Old password</label>
                        <input type="password" name="oldPassword" required>
                        <p class="error" id="old-password-error">Incorrect old password</p>
                    </div>
                  
                    <div>
                        <label for="newPassword">New password</label>
                        <input type="password" name="newPassword" required>
                        <p class="error" id="new-password-error">New password cannot be the same as old password</p>
                    </div>
                   
                    <div>
                        <label for="confirmPassword">Confirm new password</label>
                        <input type="password" name="confirmPassword" required>
                        <p class="error" id="confirm-password-error">Passwords do not match</p>    
                    </div>
                 
                    <button class="btn-styling" type="submit">Change</button> <!--BACKEND: wachtwoord is nu anders-->
                </form>
            </div>
        </section>
    
        <footer>
            <%- include('partials/footer') %> 
        </footer>

        <script>
            document.getElementById("change-password-form").addEventListener("submit", async function(event) {
                event.preventDefault(); // Voorkom standaard verzenden
    
                let oldPassword = document.getElementById("oldPassword");
                let newPassword = document.getElementById("newPassword");
                let confirmPassword = document.getElementById("confirmPassword");
    
                let oldPasswordError = document.getElementById("old-password-error");
                let newPasswordError = document.getElementById("new-password-error");
                let confirmPasswordError = document.getElementById("confirm-password-error");
    
                let isValid = true;
    
                // Check of het oude wachtwoord correct is (API-aanroep)
                let response = await fetch("http://localhost:9000/check-old-password", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ oldPassword: oldPassword.value })
                });
    
                let data = await response.json();
    
                if (!data.correct) {
                    oldPasswordError.style.display = "block";
                    oldPassword.classList.add("error-input");
                    isValid = false;
                } else {
                    oldPasswordError.style.display = "none";
                    oldPassword.classList.remove("error-input");
                }
    
                // Controle: Nieuw wachtwoord mag niet hetzelfde zijn als het oude
                if (newPassword.value === oldPassword.value) {
                    newPasswordError.innerText = "New password cannot be the same as old password";
                    newPasswordError.style.display = "block";
                    newPassword.classList.add("error-input");
                    isValid = false;
                } else {
                    newPasswordError.style.display = "none";
                    newPassword.classList.remove("error-input");
                }
    
                // Controle: Bevestigingswachtwoord moet overeenkomen
                if (newPassword.value !== confirmPassword.value) {
                    confirmPasswordError.style.display = "block";
                    confirmPassword.classList.add("error-input");
                    isValid = false;
                } else {
                    confirmPasswordError.style.display = "none";
                    confirmPassword.classList.remove("error-input");
                }
    
                // Als alles correct is, wachtwoord wijzigen
                if (isValid) {
                    let changeResponse = await fetch("http://localhost:9000/change-password", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            oldPassword: oldPassword.value,
                            newPassword: newPassword.value
                        })
                    });
    
                    let changeData = await changeResponse.json();
    
                    if (changeData.success) {
                        alert("Password changed successfully!");
                        window.location.reload();
                    } else {
                        alert("Something went wrong. Please try again.");
                    }
                }
            });
        </script>
    </body>
</html>